<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Church Member Registration Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .preview-container {
            width: 250px;
            height: 250px;
            overflow: hidden;
            border: 2px dashed #ddd;
            border-radius: 0.5rem;
        }
        #imageToCrop {
            max-width: 100%;
            display: block;
        }
        .cropper-view-box, .cropper-face {
            border-radius: 50%;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="container mx-auto p-4 sm:p-8 max-w-2xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-700">Church Member Registration Portal</h1>
            <p class="text-slate-600 mt-2">A secure and private way to pre-register for our new check-in system.</p>
        </header>

        <!-- Security Notice -->
        <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-md mb-8" role="alert">
            <p class="font-bold">Privacy Guaranteed</p>
            <p>All information and photo processing happens directly on your device. No data is uploaded or stored online.</p>
        </div>
        
        <div id="registrationForm" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
            
            <!-- Step 1: Personal Details -->
            <div>
                <h2 class="text-2xl font-semibold mb-6 border-b pb-3">Step 1: Enter Your Details</h2>
                <div class="space-y-4">
                    <div>
                        <label for="fullName" class="block text-sm font-medium text-gray-700">Full Name*</label>
                        <input type="text" id="fullName" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., John Smith">
                        <p id="fullNameError" class="text-red-500 text-xs mt-1 hidden">Full Name is required.</p>
                    </div>
                    <div>
                        <label for="membershipStatus" class="block text-sm font-medium text-gray-700">Membership Status*</label>
                        <select id="membershipStatus" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option>Member</option>
                            <option>Regular Attendee</option>
                            <option>Visitor</option>
                            <option>Newcomer</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Step 2: Photo Upload & Crop -->
            <div class="mt-8">
                <h2 class="text-2xl font-semibold mb-6 border-b pb-3">Step 2: Upload Your Photo</h2>
                 <div class="text-center bg-gray-50 p-4 rounded-lg mb-4">
                    <p class="text-sm font-medium text-gray-600">Photo Requirements:</p>
                    <ul class="text-xs text-gray-500 list-disc list-inside text-left mx-auto max-w-xs">
                        <li>Clear, front-facing photo</li>
                        <li>No sunglasses or hats</li>
                        <li>Neutral background preferred</li>
                    </ul>
                </div>
                <div class="flex flex-col items-center">
                    <input type="file" id="imageInput" accept="image/*" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 mb-4">
                     <p id="imageError" class="text-red-500 text-xs mb-2 hidden">Please select an image file.</p>
                    <div id="cropper-container" class="hidden w-full max-w-md">
                        <img id="imageToCrop" src="">
                    </div>
                </div>
            </div>
            
            <!-- Action Button -->
            <div class="mt-10 text-center">
                <button onclick="processAndPrepareDownload()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105 text-lg">Generate Download File</button>
            </div>


            <!-- Step 3: Confirmation and Download (Initially Hidden) -->
            <div id="downloadArea" class="hidden mt-10 pt-6 border-t-2 border-dashed">
                <h2 class="text-2xl font-semibold mb-6 text-center">Step 3: Download Your Files</h2>
                 <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded-md mb-6" role="alert">
                    <p class="font-bold">Administrator Action</p>
                    <p>Please download the prepared image file and copy the member's details into the master spreadsheet.</p>
                </div>
                <div class="flex flex-col sm:flex-row items-center sm:items-start space-y-6 sm:space-y-0 sm:space-x-8">
                    <div class="text-center">
                        <p class="font-bold mb-2">Formatted Photo</p>
                        <div id="preview" class="preview-container mx-auto bg-gray-200 flex items-center justify-center"></div>
                        <a id="downloadButton" href="#" class="mt-4 inline-block bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">Download Image</a>
                    </div>
                    <div class="w-full">
                        <p class="font-bold mb-2 text-center sm:text-left">Member Details</p>
                        <div class="bg-gray-50 p-4 rounded-lg space-y-2 border">
                            <div><strong>Full Name:</strong> <span id="confirmName"></span></div>
                            <div><strong>Membership:</strong> <span id="confirmStatus"></span></div>
                            <div><strong>Generated Filename:</strong> <span id="confirmFilename" class="text-sm text-gray-600 break-all"></span></div>
                        </div>
                    </div>
                </div>
                 <div class="mt-8 text-center">
                    <button onclick="startOver()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">Register New Member</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let cropper;
        const formData = {};

        const imageInput = document.getElementById('imageInput');
        const imageToCrop = document.getElementById('imageToCrop');
        const cropperContainer = document.getElementById('cropper-container');
        const downloadArea = document.getElementById('downloadArea');

        imageInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files && files.length > 0) {
                const reader = new FileReader();
                reader.onload = () => {
                    imageToCrop.src = reader.result;
                    cropperContainer.classList.remove('hidden');
                    if(cropper) {
                        cropper.destroy();
                    }
                    cropper = new Cropper(imageToCrop, {
                        aspectRatio: 1,
                        viewMode: 1,
                        background: false,
                        responsive: true,
                        autoCropArea: 0.8,
                        zoomable: true,
                    });
                };
                reader.readAsDataURL(files[0]);
                document.getElementById('imageError').classList.add('hidden');
            }
        });
        
        function validateInputs() {
            const fullName = document.getElementById('fullName').value.trim();
            const fullNameError = document.getElementById('fullNameError');
            const imageError = document.getElementById('imageError');
            
            let isValid = true;

            if (fullName === '') {
                fullNameError.classList.remove('hidden');
                isValid = false;
            } else {
                fullNameError.classList.add('hidden');
            }

            if (!imageInput.files || imageInput.files.length === 0) {
                imageError.classList.remove('hidden');
                isValid = false;
            } else {
                imageError.classList.add('hidden');
            }

            if(isValid) {
                formData.fullName = fullName;
                formData.membershipStatus = document.getElementById('membershipStatus').value;
            }

            return isValid;
        }

        function processAndPrepareDownload() {
            if (!validateInputs()) return;

            // Display confirmation details
            document.getElementById('confirmName').textContent = formData.fullName;
            document.getElementById('confirmStatus').textContent = formData.membershipStatus;
            
            // Generate unique ID (simple timestamp for uniqueness)
            const uniqueId = Date.now().toString().slice(-6);
            
            // Format filename: John_Smith_123456.jpg
            const filename = `${formData.fullName.replace(/\s+/g, '_')}_${uniqueId}.jpg`;
            document.getElementById('confirmFilename').textContent = filename;

            // Get cropped canvas
            const canvas = cropper.getCroppedCanvas({
                width: 512,
                height: 512,
                imageSmoothingQuality: 'high',
            });
            
            // Show preview
            const preview = document.getElementById('preview');
            preview.innerHTML = '';
            const previewImg = document.createElement('img');
            previewImg.src = canvas.toDataURL('image/jpeg');
            previewImg.className = 'w-full h-full object-cover rounded-md';
            preview.appendChild(previewImg);

            // Set download button
            const downloadButton = document.getElementById('downloadButton');
            canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                downloadButton.href = url;
                downloadButton.download = filename;
            }, 'image/jpeg');

            // Show the download area
            downloadArea.classList.remove('hidden');
        }

        function startOver() {
            // Reset form fields individually
            document.getElementById('fullName').value = '';
            document.getElementById('membershipStatus').selectedIndex = 0;
            document.getElementById('imageInput').value = '';

            if(cropper) cropper.destroy();
            cropperContainer.classList.add('hidden');
            
            // Clear errors and hide the download area
            document.getElementById('fullNameError').classList.add('hidden');
            document.getElementById('imageError').classList.add('hidden');
            downloadArea.classList.add('hidden');
            
            // Scroll to top
            window.scrollTo(0, 0);
        }
    </script>
</body>
</html>

